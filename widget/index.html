<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Workday Timer – Let’s Log Some Hours</title>
  <style>
    :root {
      --bg: transparent;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --accent: #936B4D;
      --border: #d9d3cd;
      --radius: 20px;
      --go: #6B8E62;
      --pause: #C49A6C;
      --stop: #C9645B;
      --btn-text: #1a1a1a;
      --btn-text-inv: #ffffff;
      --goal-track: #e6e0da;
      --goal-progress: #936B4D;
    }
    [data-theme="dark"] {
      --card: #0f1115;
      --text: #f3f4f6;
      --muted: #a1a1aa;
      --accent: #d1b59a;
      --border: #2a2f3a;
      --go: #86A67C;
      --pause: #D7B28B;
      --stop: #D07B73;
      --btn-text: #0f1115;
      --btn-text-inv: #121212;
      --goal-track: #2a2f3a;
      --goal-progress: #d1b59a;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; padding: 24px;
      font-family: ui-serif, Georgia, Cambria, 'Times New Roman', Times, serif;
      font-size: 17px;
      background: var(--bg); color: var(--text);
    }
    .widget {
      max-width: 900px; margin: 0 auto;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
    }
    header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 10px; }
    .title { font-weight: 800; letter-spacing: 0.2px; font-size: clamp(26px, 3.2vw, 42px); color: var(--accent); }
    .subtitle { font-size: 12px; color: var(--muted); margin-top: 2px; }
    .status { font-size: 12px; color: var(--muted); padding: 4px 10px; border: 1px solid var(--border); border-radius: 999px; }
    .topbar { display:flex; align-items:center; gap:8px; }
    .connect { background: var(--accent); color: white; border-color: var(--accent); }
    .bar { display:flex; flex-wrap:wrap; gap:12px; margin: 10px 0 12px; align-items:center; }
    .group { display:flex; align-items:center; gap:8px; }
    label { font-size:12px; color: var(--muted); }
    input.combo { width: 190px; background: transparent; color: var(--text); border: 1px solid var(--border); border-radius: 999px; padding: 8px 12px; }
    .pill { font-size: 12px; padding: 6px 10px; border: 1px solid var(--border); border-radius: 999px; color: var(--muted); }
    .btns { display:flex; flex-wrap:wrap; gap:8px; }
    button { appearance:none; border:1px solid var(--border); padding:10px 16px; border-radius: 999px; font-weight:600; cursor:pointer; background:#fff0; color: var(--text); transition: transform .04s ease; }
    button:active { transform: translateY(1px); }
    .go{ background: var(--go); color: var(--btn-text-inv); border-color: transparent; }
    .pause{ background: var(--pause); color: var(--btn-text); border-color: transparent; }
    .stop{ background: var(--stop); color:#fff; border-color: transparent; }
    .ghost{ border-color: var(--border); }
    .row { display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center; padding:14px; border:1px solid var(--border); border-radius:12px; margin-bottom:12px; }
    .today-label { font-size: 14px; color: var(--muted); }
    .big { font-variant-numeric: tabular-nums; font-size: clamp(36px, 6.5vw, 64px); line-height:1; font-weight: 800; }
    table { width:100%; border-collapse:collapse; margin-top:8px; }
    th, td { padding: 8px 8px; text-align:left; }
    thead th{ font-size:12px; color:var(--muted); font-weight:700; border-bottom:1px solid var(--border); }
    tbody td{ border-bottom:1px solid var(--border); font-variant-numeric: tabular-nums; }
    .hint{ margin-top:8px; font-size:12px; color:var(--muted); }
    .ring { position: relative; width: 80px; height: 80px; }
    .ring svg { position: absolute; inset: 0; }
    .ring .innerText { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:12px; color:var(--muted); pointer-events:none; }
  </style>
</head>
<body>
  <div class="widget" role="application" aria-label="Workday Timer">
    <header>
      <div>
        <div class="title">Let's Log Some Hours</div>
        <div class="subtitle">Fast, friendly time tracking</div>
      </div>
      <div class="topbar">
        <button class="ghost" id="themeBtn" title="Toggle dark mode">🌙</button>
        <button class="connect" id="connectBtn">Connect Notion</button>
        <div class="status" id="status">Not connected</div>
      </div>
    </header>

    <div class="bar">
      <div class="group">
        <label for="clientInput">Client</label>
        <input list="clientList" id="clientInput" class="combo" placeholder="Type or pick…" />
        <datalist id="clientList"></datalist>
        <button class="ghost" id="addClientBtn">+ add</button>
      </div>
      <div class="group">
        <label for="projectInput">Project</label>
        <input list="projectList" id="projectInput" class="combo" placeholder="Type or pick…" />
        <datalist id="projectList"></datalist>
        <button class="ghost" id="addProjectBtn">+ add</button>
      </div>
      <span class="pill" id="pickedPill">Tag: — / —</span>
    </div>

    <div class="row">
      <div>
        <div class="today-label" id="todayLabel"></div>
        <div class="big" id="todayBig">00:00:00</div>
        <div style="display:flex; align-items:center; gap:12px; margin-top:10px;">
          <div class="ring">
            <svg viewBox="0 0 36 36" aria-hidden="true">
              <circle cx="18" cy="18" r="15" fill="none" stroke-width="6" stroke="var(--goal-track)"></circle>
              <circle id="goalProgress" cx="18" cy="18" r="15" fill="none" stroke-width="6" stroke-linecap="round" stroke="var(--goal-progress)" stroke-dasharray="94.2" stroke-dashoffset="94.2"></circle>
            </svg>
            <div class="innerText" id="goalInside">0%</div>
          </div>
          <button class="ghost" id="goalBtn" title="Set daily goal (hours)">Daily goal</button>
          <span id="goalLabel" class="today-label"></span>
        </div>
      </div>
      <div class="btns" role="group" aria-label="Timer controls">
        <button class="go" id="goBtn">Go</button>
        <button class="pause" id="pauseBtn">Pause</button>
        <button class="stop" id="stopBtn">Stop</button>
        <button class="ghost" id="reassignBtn" title="Change client/project on last entry">Reassign last</button>
        <button class="ghost" id="deleteBtn" title="Delete your most recent time entry">Oops! Delete last</button>
      </div>
    </div>

    <table aria-label="Daily totals">
      <thead><tr><th>Day</th><th>Time worked</th></tr></thead>
      <tbody id="rows"></tbody>
    </table>

    <div class="hint">
      Connect once. On Pause/Stop we write to your Notion databases:
      <strong>Clients</strong>, <strong>Projects</strong>, and <strong>Time Log</strong>.
      You can reassign or delete the most recent entry at any time.
    </div>
  </div>

  <script>
    (function(){
      const $ = sel => document.querySelector(sel);
      const statusEl = $('#status'), connectBtn = $('#connectBtn'), themeBtn = $('#themeBtn');
      const rowsEl = $('#rows'), todayBig = $('#todayBig'), todayLabel = $('#todayLabel');
      const goBtn = $('#goBtn'), pauseBtn = $('#pauseBtn'), stopBtn = $('#stopBtn');
      const reassignBtn = $('#reassignBtn'), deleteBtn = $('#deleteBtn');
      const clientInput = $('#clientInput'), projectInput = $('#projectInput'), clientList = $('#clientList'), projectList = $('#projectList');
      const addClientBtn=$('#addClientBtn'), addProjectBtn=$('#addProjectBtn');
      const goalBtn=$('#goalBtn'), goalLabel=$('#goalLabel'), goalProgress=$('#goalProgress'), goalInside=$('#goalInside');
      const CIRC = 2 * Math.PI * 15; goalProgress.setAttribute('stroke-dasharray', String(CIRC));

      const pad = n => String(n).padStart(2,'0');
      const dateKey = (d) => [d.getFullYear(), pad(d.getMonth()+1), pad(d.getDate())].join('-');
      const prettyDate = (d) => new Intl.DateTimeFormat(undefined, { weekday:'long', month:'long', day:'numeric'}).format(d);

      const STORAGE = 'wdt:v7.1.2';
      let data = Object.assign({
        totals:{},
        status:'stopped', startCursor:null, sessionStart:null,
        token:null, theme:'light',
        goalMs:0,
        clients:[{name:'General'}], projects:[{name:'Unassigned'}],
        currentClient:0, currentProject:0,
        lastSessionId:null, lastPageId:null
      }, JSON.parse(localStorage.getItem(STORAGE) || '{}'));
      const save = () => localStorage.setItem(STORAGE, JSON.stringify(data));

      if (location.hash.includes('access_token=')) {
        const p = new URLSearchParams(location.hash.slice(1));
        data.token = decodeURIComponent(p.get('access_token'));
        save(); history.replaceState({}, document.title, location.pathname + location.search);
      }

      const applyTheme = () => { document.body.setAttribute('data-theme', data.theme==='dark' ? 'dark' : 'light'); themeBtn.textContent = data.theme==='dark' ? '☀️' : '🌙'; };
      themeBtn.addEventListener('click', () => { data.theme = data.theme==='dark' ? 'light' : 'dark'; save(); applyTheme(); }); applyTheme();

      const pickedPill = $('#pickedPill');
      const updatePill = ()=>{
        pickedPill.textContent = `Tag: ${(data.clients[data.currentClient]||{name:'—'}).name} / ${(data.projects[data.currentProject]||{name:'—'}).name}`;
      };

      const updateStatus = () => { statusEl.textContent = data.token ? (data.status.charAt(0).toUpperCase()+data.status.slice(1)) : "Not connected"; connectBtn.style.display = data.token ? 'none' : 'inline-block'; };
      connectBtn.addEventListener('click', () => { const ret = encodeURIComponent(location.href); window.location.href = '/.netlify/functions/auth-start?return=' + ret; });

      // Combobox helpers
      const renderDatalist = (el, items) => { el.innerHTML = items.map(it => `<option value="${it.name}"></option>`).join(''); };
      const syncComboFromInputs = () => {
        const ci = clientInput.value.trim();
        const pi = projectInput.value.trim();
        if (ci) {
          let idx = data.clients.findIndex(x => x.name.toLowerCase() === ci.toLowerCase());
          if (idx === -1) { data.clients.push({ name: ci }); idx = data.clients.length-1; }
          data.currentClient = idx;
        }
        if (pi) {
          let idx = data.projects.findIndex(x => x.name.toLowerCase() === pi.toLowerCase());
          if (idx === -1) { data.projects.push({ name: pi }); idx = data.projects.length-1; }
          data.currentProject = idx;
        }
        save(); renderDatalist(clientList, data.clients); renderDatalist(projectList, data.projects); updatePill();
      };

      const addItem = (listName) => {
        const name = prompt(`Add ${listName} name`); if (!name) return;
        data[listName+'s'].push({ name }); save();
        renderDatalist(listName==='client' ? clientList : projectList, listName==='client' ? data.clients : data.projects);
        if (listName==='client') { clientInput.value = name; data.currentClient = data.clients.length-1; }
        else { projectInput.value = name; data.currentProject = data.projects.length-1; }
        updatePill();
        if (data.status==='running') { pause(); setTimeout(go,0); }
      };
      addClientBtn.addEventListener('click', () => addItem('client'));
      addProjectBtn.addEventListener('click', () => addItem('project'));
      clientInput.addEventListener('change', syncComboFromInputs);
      projectInput.addEventListener('change', syncComboFromInputs);

      const midnightAfter = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate()+1, 0,0,0,0);
      const addMsTo = (day, ms) => { data.totals[day] = (data.totals[day]||0) + ms; };
      const accrueUntilNow = () => { if (data.status !== 'running' || !data.startCursor) return; let start = new Date(data.startCursor); const now = new Date(); while (start < now) { const boundary = midnightAfter(start); const chunkEnd = boundary < now ? boundary : now; addMsTo(dateKey(start), chunkEnd - start); start = chunkEnd; } data.startCursor = new Date().toISOString(); };

      function renderGoal() {
        if (!data.goalMs) { goalLabel.textContent = 'No goal'; goalProgress.style.strokeDashoffset = CIRC; goalInside.textContent = '0%'; return; }
        const now = new Date(); const kNow = dateKey(now); const todayMs = data.totals[kNow] || 0;
        const ratio = Math.max(0, Math.min(1, todayMs / data.goalMs));
        goalProgress.style.strokeDashoffset = (1 - ratio) * CIRC;
        const pct = Math.round(ratio * 100);
        goalInside.textContent = pct + '%';
        goalLabel.textContent = `${(data.goalMs/3600000).toFixed(1)}h goal`;
      }
      goalBtn.addEventListener('click', () => { const hours = Number(prompt('Set daily goal (hours):', data.goalMs ? (data.goalMs/3600000).toFixed(1) : '8')); if (!hours || hours <= 0) return; data.goalMs = Math.round(hours * 3600000); save(); renderGoal(); });

      const currentNames = () => {
        const c = (data.clients[data.currentClient] || {name:'General'}).name;
        const p = (data.projects[data.currentProject] || {name:'Unassigned'}).name;
        return { client: c, project: p };
      };

      const guardDefaults = () => {
        const {client, project} = currentNames();
        const usingDefaults = (client==='General' && project==='Unassigned');
        if (usingDefaults) {
          return confirm('Start with Client "General" and Project "Unassigned"?');
        }
        return true;
      };

      const go = () => {
        if (!data.token) { alert('Connect Notion first'); return; }
        syncComboFromInputs();
        if (!guardDefaults()) return;
        if (data.status === 'running') return;
        const nowIso = new Date().toISOString();
        data.sessionStart = nowIso;
        data.startCursor = nowIso;
        data.lastSessionId = nowIso;
        data.lastPageId = null;
        data.status = 'running'; save(); updateStatus();
      };

      const pause = async () => {
        if (data.status !== 'running') return;
        accrueUntilNow(); const endIso = new Date().toISOString(); const startIso = data.sessionStart;
        data.startCursor = null; data.sessionStart = null; data.status = 'paused'; save(); updateStatus(); renderGoal();
        const {client, project} = currentNames();
        await sendSession(startIso, endIso, client, project);
      };
      const stop = async () => {
        if (data.status === 'running') {
          accrueUntilNow(); const endIso = new Date().toISOString(); const startIso = data.sessionStart;
          data.startCursor = null; data.sessionStart = null; data.status = 'stopped'; save(); updateStatus(); renderGoal();
          const {client, project} = currentNames();
          await sendSession(startIso, endIso, client, project);
        } else { data.status = 'stopped'; save(); updateStatus(); }
      };

      goBtn.addEventListener('click', go); pauseBtn.addEventListener('click', pause); stopBtn.addEventListener('click', stop);
      window.addEventListener('keydown', (e) => { if (e.code==='Space') { e.preventDefault(); data.status==='running'?pause():go(); } if (e.key.toLowerCase()==='s') stop(); });

      async function sendSession(start, end, client, project) {
        if (!data.token) return;
        try {
          const res = await fetch('/.netlify/functions/log', {
            method:'POST',
            headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer ' + data.token },
            body: JSON.stringify({ start, end, client, project, note: '', sessionId: data.lastSessionId || start })
          });
          if (res.ok) {
            const j = await res.json();
            if (j && j.pageId) { data.lastPageId = j.pageId; save(); }
          }
          const now = new Date(); const from = new Date(); from.setDate(now.getDate()-2);
          const r = await fetch(`/.netlify/functions/totals?from=${from.toISOString().slice(0,10)}&to=${now.toISOString().slice(0,10)}`, { headers: { 'Authorization': 'Bearer ' + data.token } });
          if (r.ok) { const j2 = await r.json(); const days = j2.days || {}; Object.keys(days).forEach(k => { data.totals[k] = days[k].totalMs; }); save(); }
        } catch (e) { console.warn('sendSession failed', e); }
      }

      // Reassign last entry
      reassignBtn.addEventListener('click', async () => {
        if (!data.token) { alert('Connect Notion first'); return; }
        if (!data.lastSessionId) { alert('No recent session to reassign yet. Pause/Stop once first.'); return; }
        syncComboFromInputs();
        const {client, project} = currentNames();
        if (!confirm(`Reassign your last entry to\nClient: ${client}\nProject: ${project}?`)) return;
        try {
          const res = await fetch('/.netlify/functions/reassign', {
            method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+data.token},
            body: JSON.stringify({ sessionId: data.lastSessionId, client, project })
          });
          if (res.ok) { alert('Last entry updated.'); } else { const t=await res.text(); alert('Could not update: '+t); }
        } catch (e) { alert('Network error reassigning.'); }
      });

      // Delete last entry
      deleteBtn.addEventListener('click', async () => {
        if (!data.token) { alert('Connect Notion first'); return; }
        if (!data.lastSessionId && !data.lastPageId) { alert('No recent session to delete yet. Pause/Stop once first.'); return; }
        if (!confirm('Delete your most recent time entry from Notion? This cannot be undone.')) return;
        try {
          const res = await fetch('/.netlify/functions/delete-last', {
            method:'POST',
            headers: {'Content-Type':'application/json','Authorization':'Bearer '+data.token},
            body: JSON.stringify({ sessionId: data.lastSessionId, pageId: data.lastPageId })
          });
          if (res.ok) { alert('Last entry deleted.'); } else { const t=await res.text(); alert('Could not delete: '+t); }
        } catch (e) { alert('Network error deleting.'); }
      });

      const formatHMS = (ms) => { ms = Math.max(0, Math.floor(ms)); const s = Math.floor(ms/1000); const hh=Math.floor(s/3600), mm=Math.floor((s%3600)/60), ss=s%60; return `${pad(hh)}:${pad(mm)}:${pad(ss)}`; };
      function render() {
        const now = new Date();
        const kNow = dateKey(now);
        const y = new Date(now); y.setDate(now.getDate()-1);
        const b = new Date(now); b.setDate(now.getDate()-2);
        todayBig.textContent = formatHMS(data.totals[kNow]||0);
        todayLabel.textContent = prettyDate(now);
        const rows = [
          { k: kNow, label: 'Today' },
          { k: dateKey(y), label: 'Yesterday' },
          { k: dateKey(b), label: 'Day before' },
        ];
        rowsEl.innerHTML = rows.map(r => `<tr><td>${r.label}<div style="color:var(--muted); font-size:12px">${r.k}</div></td><td>${formatHMS(data.totals[r.k]||0)}</td></tr>`).join('');
        renderGoal(); updatePill();
      }

      const init = () => {
        if (!data.clients.length) data.clients = [{name:'General'}];
        if (!data.projects.length) data.projects = [{name:'Unassigned'}];
        renderDatalist(clientList, data.clients); renderDatalist(projectList, data.projects);
        clientInput.value = (data.clients[data.currentClient]||{name:''}).name;
        projectInput.value = (data.projects[data.currentProject]||{name:''}).name;
        updateStatus(); render(); save();
      };

      setInterval(() => { accrueUntilNow(); render(); save(); }, 1000);
      init();
    })();
  </script>
</body>
</html>
