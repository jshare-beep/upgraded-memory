
<!doctype html>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Workday Timer</title>
<style>
:root{
  --bg:#fff; --fg:#1f2937; --muted:#6b7280; --accent:#936B4D;
  --card:#fafafa; --border:#e5e7eb;
}
*{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
body{margin:0;background:var(--bg);color:var(--fg)}
.wrap{max-width:780px;margin:28px auto;padding:20px}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
.title{font-size:28px;font-weight:800;letter-spacing:.3px}
.btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.badge{font-size:13px;color:#fff;border-radius:20px;padding:4px 10px}
.grid{display:grid;grid-template-columns:1fr auto auto auto;gap:10px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
.big{font-size:54px;font-weight:800;letter-spacing:1px}
.row{display:flex;gap:8px;align-items:center}
.select{padding:8px;border:1px solid var(--border);border-radius:10px;background:#fff}
.hint{margin-top:12px;color:var(--muted);font-size:14px;line-height:1.4}
.ghost{border:1px dashed var(--border);background:transparent}
</style>
<div class="wrap">
  <div class="header">
    <div class="title">Let’s Log Some Hours</div>
    <div class="row">
      <button id="connect" class="btn">Connect Notion</button>
      <span id="status" class="badge" style="background:#9CA3AF">Not connected</span>
    </div>
  </div>

  <div class="grid">
    <div>
      <div id="today" class="muted"></div>
      <div id="clock" class="big">00:00:00</div>
      <div class="row" style="margin-top:8px">
        <select id="projectSel" class="select"><option value="">Select a project…</option></select>
        <button id="goal" class="btn ghost">Weekly Goal</button>
      </div>
    </div>
    <button id="go" class="btn" style="background:#8BA888;color:#fff;border-color:#8BA888">Go</button>
    <button id="pause" class="btn" style="background:#C8A970;color:#fff;border-color:#C8A970">Pause</button>
    <button id="stop" class="btn" style="background:#C47A6A;color:#fff;border-color:#C47A6A">Stop</button>
  </div>

  <div class="hint" id="footerHelp">
    <strong>Quick start:</strong>
    <ol style="margin:6px 0 0 16px;padding:0">
      <li>Click <em>Connect Notion</em> → approve.</li>
      <li>In Notion, invite this integration to <b>Projects</b>, <b>Clients</b>, and <b>Time Log</b> databases.</li>
      <li>Pick a <b>Project</b> and use <b>Go / Pause / Stop</b>.</li>
    </ol>
    <div style="margin-top:6px">Writes to <b>Time Log</b>. With env vars <code>WRITEBACK_PROJECT_TOTAL_PROP="Total Minutes"</code> and <code>WRITEBACK_PROJECT_TOTAL_UNIT="minutes"</code>, project totals update automatically.</div>
    <div style="margin-top:6px">Manage projects: <a id="footerOpenProjects" href="#" target="_blank" rel="noopener">Open Projects</a> (or append <code>?projects_url=YOUR_NOTION_PROJECTS_LINK</code>).</div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const params = new URLSearchParams(location.search);
const projectsUrl = params.get('projects_url') || ''; const footerOpenProjects = document.getElementById('footerOpenProjects');
if (projectsUrl) { footerOpenProjects.href = projectsUrl; } else { footerOpenProjects.style.display = 'none'; }

function inIframe(){ try { return window.self !== window.top; } catch(e){ return true; } }
const connectBtn = $("#connect");
connectBtn.addEventListener("click", () => {
  const ret = encodeURIComponent(location.pathname + location.search);
  const url = "/.netlify/functions/auth-start?return=" + ret;
  if (inIframe()) window.open(url, "_blank", "noopener"); else location.href = url;
});

let token = null;
function loadToken(){ try { token = JSON.parse(localStorage.getItem("workday_timer_token")||"null")?.access_token || null; } catch(e){} }
function saveToken(t){ try { localStorage.setItem("workday_timer_token", JSON.stringify(t)); } catch(e){} }
loadToken();

const statusBadge = $("#status");
function setStatus(ok){ statusBadge.textContent = ok ? "Connected" : "Not connected"; statusBadge.style.background = ok ? "#34D399" : "#9CA3AF"; }

async function api(path, opt={}){
  const r = await fetch(path, { ...opt, headers: { ...(opt.headers||{}), "Authorization": "Bearer " + token }});
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

async function refreshProjects(){
  if (!token) return;
  const data = await api("/.netlify/functions/lists");
  const sel = $("#projectSel");
  sel.innerHTML = '<option value="">Select a project…</option>';
  (data.projects || []).forEach(p => {
    const o = document.createElement("option");
    o.value = p.id; o.textContent = p.title; sel.appendChild(o);
  });
  setStatus(true);
}

function fmt(ms){ const s = Math.floor(ms/1000); const h = Math.floor(s/3600); const m = Math.floor(s%3600/60); const ss = s%60; const z=n=>String(n).padStart(2,"0"); return `${z(h)}:${z(m)}:${z(ss)}`; }
let t0 = 0, acc=0, tick=null;

function renderClock(){ $("#clock").textContent = fmt((t0? Date.now()-t0:0)+acc); }
setInterval(renderClock, 250);

$("#go").onclick = ()=>{ if(!$("#projectSel").value) { alert("Pick a project first"); return; } if(!tick) t0 = Date.now(); tick = true; };
$("#pause").onclick = ()=>{ if(tick){ acc += Date.now()-t0; t0 = 0; tick = false; renderClock(); } };
$("#stop").onclick = async ()=>{
  if (!$("#projectSel").value) { alert("Pick a project first"); return; }
  if (tick){ acc += Date.now()-t0; t0=0; tick=false; }
  const minutes = Math.max(1, Math.round(acc/60000));
  const date = new Date().toISOString().slice(0,10);
  await api("/.netlify/functions/write-log", { method:"POST", body: JSON.stringify({ minutes, date, project_id: $("#projectSel").value, session_id: Math.random().toString(36).slice(2) }), headers: { "content-type":"application/json" }});
  acc=0; renderClock(); alert("Saved " + minutes + " min.");
};

// Weekly goal – inline fallback (no prompt needed)
$("#goal").onclick = ()=>{
  if ($("#wgInline")) return;
  const holder = document.createElement("span"); holder.id="wgInline"; holder.style.marginLeft="8px";
  holder.innerHTML = '<input type="number" id="wgHours" min="0" step="0.5" style="width:90px;padding:6px;border:1px solid var(--border);border-radius:8px" placeholder="hours"><button id="wgSet" class="btn ghost" style="margin-left:6px">Set</button>';
  $("#goal").after(holder);
  $("#wgSet").onclick = ()=>{ holder.remove(); alert("Weekly goal saved (local only)."); };
};

(async function init(){
  setStatus(!!token);
  if (token) try { await refreshProjects(); } catch(e){ setStatus(false); }
})();
</script>
